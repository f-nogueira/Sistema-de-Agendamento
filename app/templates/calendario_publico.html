{% extends "base.html" %}

{% block title %}Calendário de Agendamentos{% endblock %}

{% block content %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Calendário de Agendamentos do Plenário</h1>
                <p class="lead">Consulte os eventos confirmados.</p>
            </div>
            <div>
                <a href="{{ url_for('main.login') }}" class="btn btn-outline-primary">Acesso Restrito</a>
            </div>
        </div>

        <div id='calendar'></div>
    </div>

    <div class="modal fade" id="eventoModal" tabindex="-1" aria-labelledby="eventoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modal-title">Título do Evento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Início:</strong> <span id="modal-start"></span></p>
            <p><strong>Fim:</strong> <span id="modal-end"></span></p>
            <hr>
            <p><strong>Descrição:</strong></p>
            <p id="modal-description"></p>
            <hr>
            <p><strong>Local:</strong> <span id="modal-local"></span></p>
            <p><strong>Responsável:</strong> <span id="modal-responsavel"></span></p>
            <hr>
            <h6>Equipamentos e Serviços Solicitados:</h6>
            <ul id="modal-servicos" class="list-unstyled"></ul>
            <hr>
            <h6>Equipe Solicitada:</h6>
            <div id="modal-equipe"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '/api/agendamentos',
                height: 'auto',

                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    
                    let evento = info.event;
                    let props = evento.extendedProps;
                    
                    const opcoesData = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };

                    document.getElementById('modal-title').textContent = evento.title;
                    document.getElementById('modal-start').textContent = evento.start.toLocaleString('pt-BR', opcoesData);
                    document.getElementById('modal-end').textContent = evento.end.toLocaleString('pt-BR', opcoesData);
                    document.getElementById('modal-description').textContent = props.description;
                    document.getElementById('modal-local').textContent = props.local;
                    document.getElementById('modal-responsavel').textContent = props.responsavel;

                    const servicosLista = document.getElementById('modal-servicos');
                    servicosLista.innerHTML = '';

                    if (props.uso_telao) servicosLista.innerHTML += '<li><i class="bi bi-check-circle-fill text-success"></i> Utilização de Telão</li>';
                    if (props.gravacao) servicosLista.innerHTML += '<li><i class="bi bi-check-circle-fill text-success"></i> Gravação do Evento</li>';
                    if (props.uso_som) servicosLista.innerHTML += '<li><i class="bi bi-check-circle-fill text-success"></i> Utilização de Sistema de Som</li>';
                    if (props.transmissao) servicosLista.innerHTML += '<li><i class="bi bi-check-circle-fill text-success"></i> Transmissão do Evento</li>';

                    const equipeDiv = document.getElementById('modal-equipe');
                    equipeDiv.innerHTML = '';
                    if (props.equipe_solicitada && props.equipe_solicitada.trim() !== '') {
                        const nomes = props.equipe_solicitada.split('\n').filter(nome => nome.trim() !== '');
                        let listaHtml = '<ul class="list-unstyled">';
                        nomes.forEach(nome => {
                            listaHtml += `<li><i class="bi bi-person-fill text-primary"></i> ${nome.trim()}</li>`;
                        });
                        listaHtml += '</ul>';
                        equipeDiv.innerHTML = listaHtml;
                    } else {
                        equipeDiv.innerHTML = '<p>Nenhuma equipe designada.</p>';
                    }

                    var eventoModal = new bootstrap.Modal(document.getElementById('eventoModal'));
                    eventoModal.show();
                }
            });

            calendar.render();
        });
    </script>
{% endblock %}